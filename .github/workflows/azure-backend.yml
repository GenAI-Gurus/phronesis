# Azure Backend Deployment Workflow for Phronesis
#
# This workflow handles backend deployment to Azure App Service (Docker) ONLY.
# It is triggered on push to main branch or manual dispatch.
#
# All CI (lint, test, build) steps are handled in ci.yml and must pass before deployment.
# This workflow assumes code is production-ready and only manages deployment.
#
# Required secrets:
#   - AZURE_WEBAPP_PUBLISH_PROFILE (for publish profile deployment)
#   - AZURE_CREDENTIALS (optional, for service principal login)
#
# Frontend deployment is managed separately.
name: Azure Backend Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "sqlite:///:memory:"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-root

      - name: Run tests
        run: PYTHONPATH=. poetry run pytest --maxfail=1 --disable-warnings --tb=short -s

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    env:
      AZURE_WEBAPP_NAME: phronesis-backend-app
      AZURE_WEBAPP_PACKAGE_PATH: backend
      DOCKERFILE_PATH: backend/Dockerfile
      PYTHON_VERSION: '3.11'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push Docker image to Azure Container Registry (if using ACR)
        if: false  # Skip if deploying directly from repo
        run: |
          echo "Add ACR build/push steps here if needed."

      - name: Deploy to Azure Web App (Docker)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: 'DOCKER|${{ github.repository }}:latest'
          # If using ACR, set images: '<youracr>.azurecr.io/phronesis-backend:latest'

      - name: Post-deployment - Run Alembic migrations
        run: |
          # SSH into the app or use Azure CLI to run migrations if needed
          echo "Manual step: Run poetry run alembic upgrade head if DB schema changed."

# Instructions:
# 1. Set your Azure Web App name above.
# 2. In Azure Portal, go to your Web App > Get publish profile. Download and copy its contents.
# 3. In GitHub repo settings > Secrets and variables > Actions, add a new secret:
#    Name: AZURE_WEBAPP_PUBLISH_PROFILE
#    Value: (paste the publish profile XML)
# 4. (Optional) For service principal login, use AZURE_CREDENTIALS instead.
