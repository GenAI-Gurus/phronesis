# Conversational Decision Chat Feature Design

## 1. Feature Goal

Replace the traditional form-based decision journal entry with a conversational, chat-based UI and backend. Users will log new decisions through a chat interface, making the process more interactive, reflective, and AI-assisted.

---

## 2. Key Requirements

### Frontend
- **Decision list/dashboard:**
  - Displays all decisions, categorized by AI-generated domain tags and sub-categorized by status (In Progress, Closed, Archived).
  - Supports filtering, sorting, and toggling archived decisions.
- **Session timeline/list per decision:**
  - Shows all sessions for a selected decision, with summaries and timestamps.
- **Chat UI for sessions:**
  - Continuing an open session from today shows only the chat history for that session.
  - Starting a new session (new day or after completion) first shows the summary of the last session (if any) and the current DecisionSummary before entering the chat.
  - Chat supports both user and AI/system messages, context-aware prompts, and persistent history.
- **Summary views:**
  - Users can review any session’s summary and the overall DecisionSummary at any time.
- Built with Material UI, React, and Chatscope.
- Integrates with backend endpoints for decision/session CRUD, message CRUD, and summary retrieval.

### Backend
- **API endpoints for:**
  - Creating, listing, updating, and archiving decisions (with domain tags and keywords generated only on description update).
  - Starting, listing, and updating sessions (including auto-completion at new day).
  - Posting and retrieving messages for sessions.
  - Fetching SessionSummary and current DecisionSummary.
  - AI-guided prompts and summarization (reflection, clarification, value extraction) using LLMs.
- **Models:** Decision, DecisionChatSession, DecisionChatMessage, SessionSummary, DecisionSummary.
- **Metadata:**
  - Domain tags and keywords are AI-generated from the decision description and remain stable unless the description changes.
  - Summaries are generated by the LLM at session completion and on-demand for the DecisionSummary.


### Testing
- Pytest coverage for all endpoints and logic (including edge/failure cases).
- Vitest + RTL for frontend flows and UI.
- Playwright E2E for full user journeys and summary generation.

---

## 3. User Flow

1. **Start or Continue a Decision**
   - User sees a list of all their decisions, categorized by domain tags (autogenerated by the system) and sub-categorized by status:
     - Status categories: In Progress, Closed. Archived decisions are hidden by default and only shown if the user presses "Show Archived".
   - Within each category, decisions are shown with title, description, summary, and last updated date, sorted by last updated.
   - User can:
     - Click "New Decision" to create a new decision (providing title and description). After submitting, the user is immediately brought to the chat UI for that decision, where the AI initiates the conversation based on the title and description.
     - Select an existing decision to continue working on it.

2. **Resume or Start a Session**
   - For the selected decision, the system checks:
     - If there is an open session from today (natural day, local time), user is taken to that session’s chat interface to continue. Only the chat history of that session is shown.
     - If there is no open session for today (either it’s a new day or all sessions are complete), a new session is automatically started in the background and the user is taken to its chat interface. If the decision has previous sessions, the summary of the last session and the overall DecisionSummary are shown to help the user catch up before starting the chat.
     - If the user left a session open from a previous day, the system auto-completes it and informs the user that a new session has started due to a new day. The summary of the last session and the overall DecisionSummary are shown before starting the new session.

3. **Chat-based Reflection (Conversational Session)**
   - User and AI interact in a chat interface for the current session:
     - AI starts with a context-aware prompt, referencing the decision’s title, description, and previous summaries.
     - User and AI exchange messages—AI asks reflective or clarifying questions, summarizes, or probes for more details; user responds or asks their own questions.
     - All messages are saved and shown in the session’s chat history.
   - User may leave and return later in the same day to continue the session.

4. **Session Completion (Manual or Automatic)**
   - The session is marked as complete when:
     - The user explicitly marks it as complete in the UI (e.g., “End Session” button).
     - OR: The system detects that a new natural day has started since the last message—auto-completes the previous session and starts a new one, informing the user.
   - When a session is completed, an AI-generated SessionSummary is created for that session.
   - The DecisionSummary is updated to reflect the current state of the decision, aggregating all sessions.

5. **Review & Recap**
   - User can view a timeline/list of all sessions for a decision, including their summaries and timestamps.
   - User can review any session’s chat history and SessionSummary.
   - User can view the current DecisionSummary, which aggregates all sessions and shows the overall state and next steps.

---

## 4. Data Model (Backend)

### Relationships
- **Decision**: Represents a high-level decision the user is working through (e.g., “Should I change jobs?”).
- **Session (DecisionChatSession)**: Each activity or chat-based reflection about a decision (could be a new angle, a follow-up, or a re-opening).
- **Message (DecisionChatMessage)**: Each user or AI utterance within a session.
- **SessionSummary**: Each session has a unique summary (one-to-one relationship).
- **DecisionSummary**: Aggregates across all sessions for a decision, providing the current state (summary of summaries).

#### Entity Relationships Table
| Entity           | Relationship                      | Cardinality          |
|------------------|-----------------------------------|----------------------|
| Decision         | has Sessions                      | 1 to many            |
| Session          | has Messages                      | 1 to many            |
| Session          | has SessionSummary                | 1 to 1               |
| Decision         | has SessionSummaries              | 1 to many            |
| Decision         | has DecisionSummaries             | 1 to many (history)  |

#### Example Diagram:
```
Decision (id)
  ├── Session (id, decision_id)
  │     ├── Message (id, session_id)
  │     └── SessionSummary (id, session_id)   # One per session
  └── DecisionSummary (id, decision_id)
```

### **Decision**
- `id` (UUID): Unique identifier for the decision.
- `user_id` (UUID, FK): The user who owns this decision.
- `title` (str): Short description of the decision.
- `description` (str): Longer free-text description of the decision (AI or user generated).
- `domain_tags` (array of str): Autogenerated tags for categorization based on description (see Domain Tag Options below). Generated only when the decision description is updated, and remain stable. Not editable by the user at this stage.

#### Domain Tag Options
> The following domain tags are used to categorize decisions. They are autogenerated by the AI based on the decision description. Multiple tags may be assigned to a single decision.
>
> - Career/Work
> - Health/Wellbeing
> - Relationships
> - Family
> - Finance/Money
> - Education/Learning
> - Personal Growth
> - Lifestyle/Leisure
> - Productivity/Time Management
> - Values/Ethics
> - Creativity/Projects
> - Spirituality/Meaning
> - Home/Environment
> - Social/Community
> - Legal/Compliance
> - Travel/Relocation
> - Other


- `keywords` (array of str, optional): Autogenerated keywords for filtering/search. Generated only when the decision description is updated, and remain stable. Not editable by the user at this stage.
- `status` (enum): "in_progress", "closed", "archived".
- `archived` (bool, default=False): Soft-delete/archive flag.
- `metadata` (JSON, optional): For extensibility (AI data, user preferences, etc.).
- `created_at`, `updated_at` (datetime)

### **DecisionChatSession**
- `id` (UUID): Unique identifier for the chat session.
- `user_id` (UUID, FK): The user who owns this session.
- `status` (enum): "active", "completed", or "archived".  
  _// Reason: Explicit enum ensures only valid states; "archived" supports soft deletion/history._
- `created_at` (datetime): When the session was started.
- `updated_at` (datetime): Last time the session was updated (any change, including messages).
- `completed_at` (datetime, optional): When the session was marked complete (null if still active).
- `title` (str, optional): Short description/title for the decision (AI/user generated).  
  _// Reason: Useful for dashboard, search, and analytics._
- `last_message_at` (datetime): Timestamp of the most recent message (for sorting/recent activity).
- `is_reviewed` (bool, default=False): Whether the user has reviewed the session after completion (for analytics, nudges).
- `archived` (bool, default=False): Soft-delete/archive flag (preserves data for audit/history).
- `metadata` (JSON, optional): For storing session-level AI data, tags, or custom fields (future-proofing).

### **DecisionChatMessage**
- `id` (UUID): Unique identifier for the message.
- `session_id` (UUID, FK): Associated chat session.
- `sender` (enum): "user", "ai", or "system".  
  _// Reason: Supports UI distinction and analytics._
- `content` (text): Message text (may include markdown or rich text for future extensibility).
- `message_type` (enum): "prompt", "response", "summary", "system_note", etc.  
  _// Reason: Enables filtering, analytics, and specialized UI rendering._
- `created_at` (datetime): When the message was sent.
- `updated_at` (datetime): Last edit (if editable).
- `parent_message_id` (UUID, optional): For threading/follow-ups or referencing prior messages.
- `metadata` (JSON, optional): For AI confidence, tags, or other structured message-level data.
- `is_visible` (bool, default=True): Soft-delete/hide flag for message moderation or user deletion.

### **SessionSummary**
- `id` (UUID): Unique identifier for the session summary.
- `session_id` (UUID, FK, unique): Associated chat session (one-to-one).
- `summary` (text): AI-generated summary of this session, considering also the previous decision summary (summary of sessions summaries) , decision title and description.
- `generated_at` (datetime): When the summary was generated.
- `source` (str): "llm", "manual", etc.

### **DecisionSummary**
- `id` (UUID): Unique identifier for the overall decision summary.
- `user_id` (UUID, FK): The user who owns this decision.
- `decision_id` (UUID, FK or composite key): (If you have a parent "decision" entity; otherwise, could be per user or per group of sessions.)
- `summary` (text): AI-generated "summary of summaries" — the current state of the decision, aggregating all sessions and considering the decision title and description.
- `status` (enum): "in_progress", "resolved", etc.
- `keywords` (array of str): Key extracted terms.
- `last_updated` (datetime): When this summary was last updated.
- `session_ids` (array of UUID): All sessions contributing to this decision.
- `metadata` (JSON, optional): For extensibility, e.g., AI confidence, tags, manual notes.
- `is_current` (bool): Whether this is the latest summary for the decision (for audit/history).

---

**Notes:**
- Each DecisionChatSession can have multiple SessionSummary entries, tracking the evolution of the session over time.
- The DecisionSummary aggregates across all sessions for a given decision, providing a "current state" for the user.
- This model supports full audit/history, recap, review, and advanced analytics.


---

## 5. API Endpoints (Backend)

- `POST /api/v1/decisions` — Create a new Decision
- `GET /api/v1/decisions/{decision_id}` — Get decision details
- `GET /api/v1/decisions` — List all decisions for a user
  - Supports filtering/grouping by domain_tags and status (in_progress, closed, archived)
  - Supports `?show_archived=true` toggle to include archived decisions
- `POST /api/v1/decisions/{decision_id}/sessions` — Start new chat session for a decision
- `GET /api/v1/decisions/{decision_id}/sessions` — List all sessions for a decision
- `GET /api/v1/decisions/sessions/{session_id}` — Get session details
- `POST /api/v1/decisions/sessions/{session_id}/messages` — Add message
- `GET /api/v1/decisions/sessions/{session_id}/messages` — Get all messages
- `PATCH /api/v1/decisions/sessions/{session_id}` — Update session (e.g., mark complete; also used for auto-completion at new day)
- `GET /api/v1/decisions/sessions/{session_id}/summary` — Get the latest SessionSummary for a session
- `GET /api/v1/decisions/{decision_id}/summary` — Get the current DecisionSummary (summary of summaries)
- (Auto-tagging, categorization, summarization, and sentiment analysis run on PATCH/complete or at new day)

---

## 6. Frontend Components

- **DecisionListPage**
  - Displays all decisions, categorized by domain_tags and sub-categorized by status (in progress, closed). Archived decisions are hidden unless user toggles "Show Archived".
  - Supports filtering, searching, and sorting by last updated.
- **NewDecisionChatPage**
  - Renders chat UI, manages session state.
  - Handles AI/system prompts and user replies.
  - Shows progress/status.
- **ChatMessageList, ChatInput**
  - Reusable components (may already exist).
- **SessionReviewPage**
  - For reviewing/editing completed sessions and displaying the latest SessionSummary for each session.
- **DecisionRecapPage**
  - Displays the current DecisionSummary (summary of summaries), showing the overall status and next steps for the decision across all sessions.

---

## 7. Testing Plan

- **Backend:**
  - Pytest for all endpoints, including:
    - Session/message CRUD
    - SessionSummary creation/versioning
    - DecisionSummary aggregation
    - Auto-tagging and summarization logic
    - Edge/failure cases for summary history and aggregation
- **Frontend:**
  - Vitest/RTL for:
    - Chat UI and message handling
    - Session summary display and versioning
    - Decision summary/recap display
    - Error/edge cases
- **E2E:**
  - Playwright for full user flow:
    - Start, converse, complete, and review a session
    - View session summaries and overall decision recap
    - Test summary versioning and aggregation across sessions

---

## 8. LLM Prompt Templates

### System Prompt (LLM Role Instruction, prepend to all sessionprompts)
```
You are a warm, non-judgmental decision coach. Your job is to help the user reflect on their decisions, clarify their values, and consider options. Always use a supportive, empathetic tone, while questioning and criticizing the user's decisions to help them grow and make better decisions.
```

### 1. Session Opening Prompt

**If first session for a decision:**
```
{system_prompt}

The user is beginning a new decision journal entry.

Decision Title: "{decision_title}"
Description: "{decision_description}"

Greet the user, briefly restate their decision, and invite them to share what’s on their mind about this decision today.
```

**If not first session:**
```
{system_prompt}

The user is continuing their reflective decision-making process.

Decision Title: "{decision_title}"
Description: "{decision_description}"
Last Session Summary: "{last_session_summary}"
Current Overall Decision Summary: "{decision_summary}"

Greet the user, recap their progress, and ask what has changed or what they’d like to focus on today. Ask the user to reflect on potential open points or next steps related to the current decision as reflected in the last session summary and overall decision summary.
```

### 2. Reflection/Probing Prompt

- **If the user is continuing an open session:**
  - Provide the full message history of the session (including the opening prompt) as context to the LLM.
  - Do not generate a new explicit reflection/probing prompt—the LLM should reply naturally in the context of the ongoing conversation.

### 3. Summarization Prompt
```
You are an expert at summarizing reflective conversations.

Here is the full chat history for this session:
{session_chat_history}

Summarize the key points discussed, any decisions made, outstanding questions, and suggest next steps. The summary should be concise, actionable, and supportive.
```

### 4. Decision Summary Prompt (Summary of Summaries)
```
You are an expert at synthesizing and summarizing decision-making processes.

Here are the summaries of all sessions for this decision:
{session_summaries}

Decision Title: "{decision_title}"
Description: "{decision_description}"

Based on the above, write a concise, actionable summary of the overall decision status, including key themes, progress made, unresolved questions, and suggested next steps. This summary should help the user quickly understand where they stand and what to focus on next.
```

### 5. Auto-Select Domain Tags and Keywords Prompt (OpenAI Function Calling)

**Function Schema (for backend/tools parameter):**
```json
{
  "type": "function",
  "function": {
    "name": "auto_tag_decision",
    "description": "Auto-select the most relevant domain tag and up to 5 keywords for a decision based on its description.",
    "parameters": {
      "type": "object",
      "properties": {
        "domain_tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "A single most relevant domain tag from the list below."
        },
        "keywords": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Up to 5 keywords representing the decision's main topics or themes."
        }
      },
      "required": ["domain_tags", "keywords"]
    }
  }
}
```

**System Prompt (for the LLM):**
```
You are an expert at categorizing and tagging decision descriptions.

Given the following decision description:
"{decision_description}"

Select ONE domain tag from this list:
- Career/Work
- Health/Wellbeing
- Relationships
- Family
- Finance/Money
- Education/Learning
- Personal Growth
- Lifestyle/Leisure
- Productivity/Time Management
- Values/Ethics
- Creativity/Projects
- Spirituality/Meaning
- Home/Environment
- Social/Community
- Legal/Compliance
- Travel/Relocation
- Other

Also, extract up to 5 keywords that best represent the main topics or themes of the decision.

You MUST call the function `auto_tag_decision` with your answer. Do NOT return plain text—respond only by calling the function with the required arguments.
```

**Backend Implementation Note:**
- Pass the function schema as a tool to the OpenAI API.
- The LLM will respond with a function_call, including the arguments (domain_tags and keywords).
- Your backend extracts these arguments and stores them as structured metadata.

---

## Acceptance Criteria: Conversational Decision Chat

> **Reference:** Each acceptance criterion below is explicitly mapped to one or more system E2E tests in [tests/system/decision_chat_e2e_tests.md](../tests/system/decision_chat_e2e_tests.md). See that file for detailed test scenarios and implementation guidance.

### 1. Decision Creation & Listing
- [ ] User can create a new decision via a chat-based UI, providing a title and description interactively. [Test 1.1]
- [ ] The chat UI validates that the decision title and description are non-empty and within allowed length limits. User receives immediate feedback on validation errors. [Test 1.2]
- [ ] On creation, the system auto-assigns domain_tags and keywords using LLM function calling, strictly from the allowed list. The user cannot manually edit these tags or keywords. [Test 1.3, 1.4]
- [ ] The chat UI shows the title, description, and auto-assigned tags/keywords for the new decision. [Test 1.3]
- [ ] The decision dashboard displays all decisions, grouped by domain_tags (as primary category) and sub-categorized by status (In Progress, Closed, Archived). [Test 1.5]
- [ ] Within each domain group and status, decisions are sorted by last updated date (descending by default). [Test 1.5]
- [ ] Each decision card/list item shows: title, description, assigned domain tag, keywords, status, and last updated date. [Test 1.5]
- [ ] The dashboard supports searching decisions by title, description, or keywords (case-insensitive, partial match). [Test 1.5]
- [ ] User can filter decisions by domain_tag(s) and/or status using UI controls (e.g., dropdowns, chips, toggles). [Test 1.5]
- [ ] Archived decisions are hidden by default and only shown if the user toggles “Show Archived.” [Test 1.6]
- [ ] User can change a decision’s status (In Progress, Closed, Archived) from the dashboard or decision detail view. [Test 1.7]
- [ ] Status changes immediately update the dashboard grouping and are persisted to the backend. [Test 1.7]
- [ ] If a decision’s description is updated, the system re-runs LLM tagging and updates domain_tags/keywords accordingly (with user notification). [Test 1.8]
- [ ] All API errors, validation issues, or backend failures are surfaced to the user with actionable feedback and do not break the dashboard UI. [Test 1.9]
- [ ] The UI and API handle edge cases (e.g., duplicate titles, extremely long descriptions, network errors, empty dashboard states) gracefully. [Test 1.10]

### 2. Session Management
- [ ] For a selected decision, if there is an open session from today (natural day, local time), the user is taken directly to that session’s chat interface and sees only the chat history for that session. [Test 2.1]
- [ ] The UI clearly shows the session date and status (active/completed). [Test 2.1]
- [ ] If there is no open session for today (either it’s a new day or all sessions are complete), the system automatically creates a new session in the background, and the user is shown: [Test 2.2]
    - The summary of the last session (if any) [Test 2.2]
    - The current DecisionSummary [Test 2.2]
    - A clear UI notification that a new session has started [Test 2.2]
- [ ] If a user left a session open from a previous day, the system auto-completes that session at the start of a new natural day (local time), persists the completion, and informs the user that a new session has started due to the new day. [Test 2.3]
- [ ] The UI provides clear feedback when a session is auto-completed or a new session is started automatically (e.g., banner, toast, or modal). [Test 2.3]
- [ ] User can manually mark a session as complete at any time; the UI updates and a SessionSummary is generated. [Test 2.4]
- [ ] Completed sessions are read-only in the chat UI; users can review the chat history and summary but cannot add new messages. [Test 2.5]
- [ ] All session boundaries and time calculations respect the user’s local time zone, regardless of backend/server time. [Test 2.6]
- [ ] If session creation or completion fails due to API or backend errors, the user is shown a clear error message and can retry the action. [Test 2.7]
- [ ] The system prevents multiple open sessions for the same decision on the same day. [Test 2.8]
- [ ] The UI and API handle edge cases such as rapid session switching, network errors, and session data loss gracefully, always preserving user progress. [Test 2.9]
- [ ] All session status changes (active, completed, auto-completed) are persisted and reflected in both the session timeline and dashboard. [Test 2.1, 2.3, 2.4]

### 3. Chat-Based Reflection
- [ ] User and AI interact in a chat interface for the current session, with real-time updates and smooth UX. [Test 3.1, 3.2, 3.3]
- [ ] The AI always starts the session with a context-aware prompt referencing the decision’s title, description, and previous summaries. [Test 3.1]
- [ ] The chat UI clearly distinguishes between user, AI, and system messages (e.g., color, avatar, label). [Test 3.2]
- [ ] The system supports message types such as prompt, response, summary, and system_note, enabling filtering and analytics. [Test 3.2]
- [ ] All messages (user, AI, system) are persisted to the backend and shown in the session’s chat history in correct chronological order. [Test 3.3]
- [ ] Chat history is loaded efficiently and includes scrollback for long sessions; no message is lost between reloads or device switches. [Test 3.3]
- [ ] User may leave and return later in the same day to continue the session, always seeing the full message history and session context. [Test 3.3]
- [ ] The chat UI supports markdown/rich text rendering for messages, including links and basic formatting. [Test 3.4]
- [ ] If the AI fails to respond or the LLM API errors, the user is shown a clear error message and can retry their message. [Test 3.6]
- [ ] Edge cases (e.g., network loss, backend downtime, very long messages, unsupported content) are handled gracefully, preserving user input and progress. [Test 3.7]

### 4. Summaries
- [ ] At session completion (manual or automatic), the system generates a SessionSummary using the LLM prompt. [Test 4.1]
- [ ] The DecisionSummary (“summary of summaries”) is generated/updated, aggregating all sessions for the decision. [Test 4.2]
- [ ] User can review any session’s summary and the overall DecisionSummary at any time. [Test 4.3]
